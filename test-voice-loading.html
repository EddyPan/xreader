<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>语音加载测试 - 安卓Edge浏览器</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a9e;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <h1>语音加载测试工具</h1>
    <p>专门测试安卓Edge浏览器中Web Speech API的语音加载问题</p>

    <div class="test-section">
        <h2>1. 语音列表检测</h2>
        <button id="checkVoices">检测语音列表</button>
        <button id="checkSupport">检测浏览器支持</button>
        <div id="voiceStatus" class="status"></div>
        <div id="voiceList" class="log"></div>
    </div>

    <div class="test-section">
        <h2>2. 语音合成测试</h2>
        <button id="testSpeak">测试朗读</button>
        <button id="testSpeakWithVoice">使用指定音色朗读</button>
        <input type="text" id="testText" value="你好，这是一个语音合成测试。" style="width: 100%; padding: 8px; margin: 10px 0;">
        <div id="speakStatus" class="status"></div>
    </div>

    <div class="test-section">
        <h2>3. 事件监听测试</h2>
        <button id="listenVoicesChanged">监听voiceschanged事件</button>
        <button id="triggerVoiceLoad">触发语音加载</button>
        <div id="eventLog" class="log"></div>
    </div>

    <div class="test-section">
        <h2>4. 新方案测试</h2>
        <p><strong>新方案：</strong>页面加载时调用getVoices()并监听voiceschanged事件，用户交互时通过空白朗读强制初始化语音引擎</p>
        <button id="initVoiceEngine">强制初始化语音引擎</button>
        <button id="testNewSolution">完整测试新方案</button>
        <button id="resetState">重置状态</button>
        <div id="newSolutionLog" class="log"></div>
    </div>

    <div class="test-section">
        <h2>5. 传统解决方案测试</h2>
        <button id="forceLoadVoices">强制加载语音</button>
        <button id="retryWithDelay">延迟重试加载</button>
        <div id="solutionLog" class="log"></div>
    </div>

    <script>
        let eventLogDiv = document.getElementById('eventLog');
        let solutionLogDiv = document.getElementById('solutionLog');
        let voiceListDiv = document.getElementById('voiceList');
        let newSolutionLogDiv = document.getElementById('newSolutionLog');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            if (type === 'event') {
                eventLogDiv.innerHTML += logEntry + '<br>';
                eventLogDiv.scrollTop = eventLogDiv.scrollHeight;
            } else if (type === 'solution') {
                solutionLogDiv.innerHTML += logEntry + '<br>';
                solutionLogDiv.scrollTop = solutionLogDiv.scrollHeight;
            } else if (type === 'newSolution') {
                newSolutionLogDiv.innerHTML += logEntry + '<br>';
                newSolutionLogDiv.scrollTop = newSolutionLogDiv.scrollHeight;
            } else {
                console.log(logEntry);
            }
        }

        function updateStatus(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // 1. 语音列表检测
        document.getElementById('checkVoices').addEventListener('click', function() {
            const voices = window.speechSynthesis.getVoices();
            const voiceCount = voices.length;
            
            updateStatus('voiceStatus', `检测到 ${voiceCount} 个语音`, voiceCount > 0 ? 'success' : 'warning');
            
            voiceListDiv.innerHTML = '';
            if (voiceCount === 0) {
                voiceListDiv.innerHTML = '语音列表为空 - 这是安卓Edge浏览器的已知问题';
            } else {
                voices.forEach((voice, index) => {
                    voiceListDiv.innerHTML += `${index + 1}. ${voice.name} (${voice.lang})<br>`;
                });
            }
        });

        document.getElementById('checkSupport').addEventListener('click', function() {
            const hasSupport = 'speechSynthesis' in window;
            const voices = hasSupport ? window.speechSynthesis.getVoices() : [];
            const message = hasSupport ? 
                `浏览器支持Web Speech API，当前有 ${voices.length} 个语音` : 
                '浏览器不支持Web Speech API';
            
            updateStatus('voiceStatus', message, hasSupport ? 'success' : 'error');
        });

        // 2. 语音合成测试
        document.getElementById('testSpeak').addEventListener('click', function() {
            const text = document.getElementById('testText').value;
            
            if (!window.speechSynthesis) {
                updateStatus('speakStatus', '浏览器不支持语音合成', 'error');
                return;
            }

            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) {
                updateStatus('speakStatus', '语音列表为空，无法朗读', 'warning');
                return;
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.onstart = () => {
                updateStatus('speakStatus', '正在朗读...', 'success');
            };
            utterance.onend = () => {
                updateStatus('speakStatus', '朗读完成', 'success');
            };
            utterance.onerror = (event) => {
                updateStatus('speakStatus', `朗读错误: ${event.error}`, 'error');
            };

            window.speechSynthesis.speak(utterance);
        });

        document.getElementById('testSpeakWithVoice').addEventListener('click', function() {
            const text = document.getElementById('testText').value;
            const voices = window.speechSynthesis.getVoices();
            
            if (voices.length === 0) {
                updateStatus('speakStatus', '没有可用的语音', 'warning');
                return;
            }

            // 优先选择中文语音
            let selectedVoice = voices.find(voice => voice.lang.includes('zh')) || voices[0];
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.voice = selectedVoice;
            utterance.onstart = () => {
                updateStatus('speakStatus', `使用 ${selectedVoice.name} 朗读中...`, 'success');
            };
            utterance.onend = () => {
                updateStatus('speakStatus', '朗读完成', 'success');
            };

            window.speechSynthesis.speak(utterance);
        });

        // 3. 事件监听测试
        document.getElementById('listenVoicesChanged').addEventListener('click', function() {
            log('开始监听voiceschanged事件...', 'event');
            
            window.speechSynthesis.onvoiceschanged = function() {
                const voices = window.speechSynthesis.getVoices();
                log(`voiceschanged事件触发！当前有 ${voices.length} 个语音`, 'event');
            };
            
            log('已设置voiceschanged事件监听器', 'event');
        });

        document.getElementById('triggerVoiceLoad').addEventListener('click', function() {
            log('手动触发语音加载...', 'event');
            
            // 尝试多种方法触发语音加载
            const voices = window.speechSynthesis.getVoices();
            log(`直接调用getVoices()返回 ${voices.length} 个语音`, 'event');
            
            // 创建并取消一个朗读任务，有时可以触发语音加载
            const testUtterance = new SpeechSynthesisUtterance('测试');
            testUtterance.volume = 0; // 静音
            window.speechSynthesis.speak(testUtterance);
            window.speechSynthesis.cancel();
            
            log('已尝试通过创建朗读任务触发加载', 'event');
        });

        // 4. 解决方案测试
        document.getElementById('forceLoadVoices').addEventListener('click', function() {
            log('尝试强制加载语音...', 'solution');
            
            function tryLoadVoices() {
                const voices = window.speechSynthesis.getVoices();
                log(`尝试加载: 当前有 ${voices.length} 个语音`, 'solution');
                
                if (voices.length === 0) {
                    // 如果仍然为空，等待一段时间后重试
                    setTimeout(() => {
                        if (window.speechSynthesis.getVoices().length === 0) {
                            log('语音仍为空，建议用户手动开启浏览器朗读功能', 'solution');
                        }
                    }, 2000);
                } else {
                    log(`成功加载 ${voices.length} 个语音！`, 'solution');
                }
                
                return voices;
            }
            
            // 立即尝试
            tryLoadVoices();
            
            // 设置监听器
            window.speechSynthesis.onvoiceschanged = function() {
                const voices = window.speechSynthesis.getVoices();
                log(`voiceschanged事件: 现在有 ${voices.length} 个语音`, 'solution');
            };
        });

        document.getElementById('retryWithDelay').addEventListener('click', function() {
            log('开始延迟重试加载语音...', 'solution');
            
            let retryCount = 0;
            const maxRetries = 5;
            
            function retry() {
                retryCount++;
                const voices = window.speechSynthesis.getVoices();
                
                log(`第 ${retryCount} 次重试: ${voices.length} 个语音`, 'solution');
                
                if (voices.length === 0 && retryCount < maxRetries) {
                    setTimeout(retry, 1000); // 每秒重试一次
                } else if (voices.length > 0) {
                    log(`成功！在第 ${retryCount} 次重试时加载了语音`, 'solution');
                } else {
                    log(`重试 ${maxRetries} 次后仍未加载语音，可能需要手动干预`, 'solution');
                }
            }
            
            // 设置监听器
            window.speechSynthesis.onvoiceschanged = function() {
                const voices = window.speechSynthesis.getVoices();
                log(`voiceschanged事件触发: ${voices.length} 个语音`, 'solution');
                if (voices.length > 0) {
                    log('语音已加载，可以停止重试', 'solution');
                }
            };
            
            retry();
        });

        // 新方案：页面加载时初始化 + 用户交互强制初始化
        let initializationAttempted = false;
        let voicesChangedReceived = false;

        /**
         * 页面加载时的初始化函数
         * 调用getVoices()并设置事件监听
         */
        function initializeOnLoad() {
            log('页面加载 - 开始初始化语音系统...', 'newSolution');
            
            // 1. 立即调用getVoices()
            const initialVoices = window.speechSynthesis.getVoices();
            log(`初始getVoices()返回: ${initialVoices.length} 个语音`, 'newSolution');
            
            // 2. 设置voiceschanged事件监听
            window.speechSynthesis.onvoiceschanged = function() {
                voicesChangedReceived = true;
                const voices = window.speechSynthesis.getVoices();
                log(`🎉 voiceschanged事件触发！现在有 ${voices.length} 个语音`, 'newSolution');
                
                if (voices.length > 0) {
                    log('✅ 语音列表已成功加载', 'newSolution');
                    updateStatus('voiceStatus', `语音加载成功！共 ${voices.length} 个语音`, 'success');
                }
            };
            
            log('✅ 已设置voiceschanged事件监听器', 'newSolution');
            
            if (initialVoices.length === 0) {
                log('⚠️ 初始语音列表为空，等待用户交互触发强制初始化', 'newSolution');
                updateStatus('voiceStatus', '语音列表为空，请点击按钮强制初始化', 'warning');
            }
        }

        /**
         * 强制初始化语音引擎
         * 通过空白朗读触发语音系统初始化
         */
        function forceInitializeVoiceEngine() {
            log('🚀 执行强制初始化语音引擎...', 'newSolution');
            
            if (!window.speechSynthesis) {
                log('❌ 浏览器不支持语音合成', 'newSolution');
                return;
            }
            
            try {
                // 创建一个空白的语音合成请求
                const emptyUtterance = new SpeechSynthesisUtterance('');
                emptyUtterance.volume = 0; // 静音，避免用户听到声音
                
                log('🔄 创建空白语音请求...', 'newSolution');
                
                // 监听事件以确保初始化完成
                emptyUtterance.onstart = function() {
                    log('✅ 空白语音请求已开始（引擎已激活）', 'newSolution');
                };
                
                emptyUtterance.onend = function() {
                    log('✅ 空白语音请求已完成', 'newSolution');
                    
                    // 检查语音列表是否已更新
                    setTimeout(() => {
                        const voices = window.speechSynthesis.getVoices();
                        log(`📝 强制初始化后getVoices()返回: ${voices.length} 个语音`, 'newSolution');
                        
                        if (voices.length > 0) {
                            log('🎉 成功！强制初始化已生效', 'newSolution');
                            updateStatus('voiceStatus', `强制初始化成功！共 ${voices.length} 个语音`, 'success');
                        } else {
                            log('⚠️ 强制初始化可能未完成，等待voiceschanged事件...', 'newSolution');
                        }
                    }, 100);
                };
                
                // 立即执行空白朗读以强制初始化
                window.speechSynthesis.speak(emptyUtterance);
                log('✅ 已发送空白语音请求', 'newSolution');
                
                initializationAttempted = true;
                
            } catch (error) {
                log(`❌ 强制初始化失败: ${error.message}`, 'newSolution');
            }
        }

        /**
         * 完整测试新方案
         */
        function testCompleteSolution() {
            log('🧪 开始完整测试新方案...', 'newSolution');
            
            // 步骤1: 检查当前状态
            const currentVoices = window.speechSynthesis.getVoices();
            log(`📊 当前语音数量: ${currentVoices.length}`, 'newSolution');
            
            if (currentVoices.length > 0) {
                log('✅ 语音列表已加载，无需强制初始化', 'newSolution');
                return;
            }
            
            // 步骤2: 执行强制初始化
            log('🔄 语音列表为空，执行强制初始化...', 'newSolution');
            forceInitializeVoiceEngine();
            
            // 步骤3: 等待并验证结果
            setTimeout(() => {
                const finalVoices = window.speechSynthesis.getVoices();
                log(`⏰ 等待后语音数量: ${finalVoices.length}`, 'newSolution');
                
                if (finalVoices.length > 0) {
                    log('🎉 新方案测试成功！', 'newSolution');
                } else if (voicesChangedReceived) {
                    log('⚠️ voiceschanged事件已触发但语音仍为空，可能需要其他方法', 'newSolution');
                } else {
                    log('⏳ voiceschanged事件尚未触发，继续等待...', 'newSolution');
                }
            }, 2000);
        }

        /**
         * 重置状态
         */
        function resetState() {
            initializationAttempted = false;
            voicesChangedReceived = false;
            newSolutionLogDiv.innerHTML = '';
            log('🔄 状态已重置', 'newSolution');
            updateStatus('voiceStatus', '状态已重置', 'success');
        }

        // 绑定新方案按钮事件
        document.getElementById('initVoiceEngine').addEventListener('click', forceInitializeVoiceEngine);
        document.getElementById('testNewSolution').addEventListener('click', testCompleteSolution);
        document.getElementById('resetState').addEventListener('click', resetState);

        // 页面加载时自动检测
        window.addEventListener('load', function() {
            log('页面加载完成，自动检测语音状态...', 'solution');
            const voices = window.speechSynthesis.getVoices();
            log(`初始状态: ${voices.length} 个语音`, 'solution');
            
            if (voices.length === 0) {
                updateStatus('voiceStatus', '检测到语音列表为空，这是安卓Edge浏览器的已知问题', 'warning');
            }
            
            // 执行新方案的初始化
            initializeOnLoad();
        });
    </script>
</body>
</html>