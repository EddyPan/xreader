<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>è¯­éŸ³åŠ è½½æµ‹è¯• - å®‰å“Edgeæµè§ˆå™¨</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a9e;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <h1>è¯­éŸ³åŠ è½½æµ‹è¯•å·¥å…·</h1>
    <p>ä¸“é—¨æµ‹è¯•å®‰å“Edgeæµè§ˆå™¨ä¸­Web Speech APIçš„è¯­éŸ³åŠ è½½é—®é¢˜</p>

    <div class="test-section">
        <h2>1. è¯­éŸ³åˆ—è¡¨æ£€æµ‹</h2>
        <button id="checkVoices">æ£€æµ‹è¯­éŸ³åˆ—è¡¨</button>
        <button id="checkSupport">æ£€æµ‹æµè§ˆå™¨æ”¯æŒ</button>
        <div id="voiceStatus" class="status"></div>
        <div id="voiceList" class="log"></div>
    </div>

    <div class="test-section">
        <h2>2. è¯­éŸ³åˆæˆæµ‹è¯•</h2>
        <button id="testSpeak">æµ‹è¯•æœ—è¯»</button>
        <button id="testSpeakWithVoice">ä½¿ç”¨æŒ‡å®šéŸ³è‰²æœ—è¯»</button>
        <input type="text" id="testText" value="ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªè¯­éŸ³åˆæˆæµ‹è¯•ã€‚" style="width: 100%; padding: 8px; margin: 10px 0;">
        <div id="speakStatus" class="status"></div>
    </div>

    <div class="test-section">
        <h2>3. äº‹ä»¶ç›‘å¬æµ‹è¯•</h2>
        <button id="listenVoicesChanged">ç›‘å¬voiceschangedäº‹ä»¶</button>
        <button id="triggerVoiceLoad">è§¦å‘è¯­éŸ³åŠ è½½</button>
        <div id="eventLog" class="log"></div>
    </div>

    <div class="test-section">
        <h2>4. æ–°æ–¹æ¡ˆæµ‹è¯•</h2>
        <p><strong>æ–°æ–¹æ¡ˆï¼š</strong>é¡µé¢åŠ è½½æ—¶è°ƒç”¨getVoices()å¹¶ç›‘å¬voiceschangedäº‹ä»¶ï¼Œç”¨æˆ·äº¤äº’æ—¶é€šè¿‡ç©ºç™½æœ—è¯»å¼ºåˆ¶åˆå§‹åŒ–è¯­éŸ³å¼•æ“</p>
        <button id="initVoiceEngine">å¼ºåˆ¶åˆå§‹åŒ–è¯­éŸ³å¼•æ“</button>
        <button id="testNewSolution">å®Œæ•´æµ‹è¯•æ–°æ–¹æ¡ˆ</button>
        <button id="resetState">é‡ç½®çŠ¶æ€</button>
        <div id="newSolutionLog" class="log"></div>
    </div>

    <div class="test-section">
        <h2>5. ä¼ ç»Ÿè§£å†³æ–¹æ¡ˆæµ‹è¯•</h2>
        <button id="forceLoadVoices">å¼ºåˆ¶åŠ è½½è¯­éŸ³</button>
        <button id="retryWithDelay">å»¶è¿Ÿé‡è¯•åŠ è½½</button>
        <div id="solutionLog" class="log"></div>
    </div>

    <script>
        let eventLogDiv = document.getElementById('eventLog');
        let solutionLogDiv = document.getElementById('solutionLog');
        let voiceListDiv = document.getElementById('voiceList');
        let newSolutionLogDiv = document.getElementById('newSolutionLog');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            if (type === 'event') {
                eventLogDiv.innerHTML += logEntry + '<br>';
                eventLogDiv.scrollTop = eventLogDiv.scrollHeight;
            } else if (type === 'solution') {
                solutionLogDiv.innerHTML += logEntry + '<br>';
                solutionLogDiv.scrollTop = solutionLogDiv.scrollHeight;
            } else if (type === 'newSolution') {
                newSolutionLogDiv.innerHTML += logEntry + '<br>';
                newSolutionLogDiv.scrollTop = newSolutionLogDiv.scrollHeight;
            } else {
                console.log(logEntry);
            }
        }

        function updateStatus(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // 1. è¯­éŸ³åˆ—è¡¨æ£€æµ‹
        document.getElementById('checkVoices').addEventListener('click', function() {
            const voices = window.speechSynthesis.getVoices();
            const voiceCount = voices.length;
            
            updateStatus('voiceStatus', `æ£€æµ‹åˆ° ${voiceCount} ä¸ªè¯­éŸ³`, voiceCount > 0 ? 'success' : 'warning');
            
            voiceListDiv.innerHTML = '';
            if (voiceCount === 0) {
                voiceListDiv.innerHTML = 'è¯­éŸ³åˆ—è¡¨ä¸ºç©º - è¿™æ˜¯å®‰å“Edgeæµè§ˆå™¨çš„å·²çŸ¥é—®é¢˜';
            } else {
                voices.forEach((voice, index) => {
                    voiceListDiv.innerHTML += `${index + 1}. ${voice.name} (${voice.lang})<br>`;
                });
            }
        });

        document.getElementById('checkSupport').addEventListener('click', function() {
            const hasSupport = 'speechSynthesis' in window;
            const voices = hasSupport ? window.speechSynthesis.getVoices() : [];
            const message = hasSupport ? 
                `æµè§ˆå™¨æ”¯æŒWeb Speech APIï¼Œå½“å‰æœ‰ ${voices.length} ä¸ªè¯­éŸ³` : 
                'æµè§ˆå™¨ä¸æ”¯æŒWeb Speech API';
            
            updateStatus('voiceStatus', message, hasSupport ? 'success' : 'error');
        });

        // 2. è¯­éŸ³åˆæˆæµ‹è¯•
        document.getElementById('testSpeak').addEventListener('click', function() {
            const text = document.getElementById('testText').value;
            
            if (!window.speechSynthesis) {
                updateStatus('speakStatus', 'æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ', 'error');
                return;
            }

            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) {
                updateStatus('speakStatus', 'è¯­éŸ³åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•æœ—è¯»', 'warning');
                return;
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.onstart = () => {
                updateStatus('speakStatus', 'æ­£åœ¨æœ—è¯»...', 'success');
            };
            utterance.onend = () => {
                updateStatus('speakStatus', 'æœ—è¯»å®Œæˆ', 'success');
            };
            utterance.onerror = (event) => {
                updateStatus('speakStatus', `æœ—è¯»é”™è¯¯: ${event.error}`, 'error');
            };

            window.speechSynthesis.speak(utterance);
        });

        document.getElementById('testSpeakWithVoice').addEventListener('click', function() {
            const text = document.getElementById('testText').value;
            const voices = window.speechSynthesis.getVoices();
            
            if (voices.length === 0) {
                updateStatus('speakStatus', 'æ²¡æœ‰å¯ç”¨çš„è¯­éŸ³', 'warning');
                return;
            }

            // ä¼˜å…ˆé€‰æ‹©ä¸­æ–‡è¯­éŸ³
            let selectedVoice = voices.find(voice => voice.lang.includes('zh')) || voices[0];
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.voice = selectedVoice;
            utterance.onstart = () => {
                updateStatus('speakStatus', `ä½¿ç”¨ ${selectedVoice.name} æœ—è¯»ä¸­...`, 'success');
            };
            utterance.onend = () => {
                updateStatus('speakStatus', 'æœ—è¯»å®Œæˆ', 'success');
            };

            window.speechSynthesis.speak(utterance);
        });

        // 3. äº‹ä»¶ç›‘å¬æµ‹è¯•
        document.getElementById('listenVoicesChanged').addEventListener('click', function() {
            log('å¼€å§‹ç›‘å¬voiceschangedäº‹ä»¶...', 'event');
            
            window.speechSynthesis.onvoiceschanged = function() {
                const voices = window.speechSynthesis.getVoices();
                log(`voiceschangedäº‹ä»¶è§¦å‘ï¼å½“å‰æœ‰ ${voices.length} ä¸ªè¯­éŸ³`, 'event');
            };
            
            log('å·²è®¾ç½®voiceschangedäº‹ä»¶ç›‘å¬å™¨', 'event');
        });

        document.getElementById('triggerVoiceLoad').addEventListener('click', function() {
            log('æ‰‹åŠ¨è§¦å‘è¯­éŸ³åŠ è½½...', 'event');
            
            // å°è¯•å¤šç§æ–¹æ³•è§¦å‘è¯­éŸ³åŠ è½½
            const voices = window.speechSynthesis.getVoices();
            log(`ç›´æ¥è°ƒç”¨getVoices()è¿”å› ${voices.length} ä¸ªè¯­éŸ³`, 'event');
            
            // åˆ›å»ºå¹¶å–æ¶ˆä¸€ä¸ªæœ—è¯»ä»»åŠ¡ï¼Œæœ‰æ—¶å¯ä»¥è§¦å‘è¯­éŸ³åŠ è½½
            const testUtterance = new SpeechSynthesisUtterance('æµ‹è¯•');
            testUtterance.volume = 0; // é™éŸ³
            window.speechSynthesis.speak(testUtterance);
            window.speechSynthesis.cancel();
            
            log('å·²å°è¯•é€šè¿‡åˆ›å»ºæœ—è¯»ä»»åŠ¡è§¦å‘åŠ è½½', 'event');
        });

        // 4. è§£å†³æ–¹æ¡ˆæµ‹è¯•
        document.getElementById('forceLoadVoices').addEventListener('click', function() {
            log('å°è¯•å¼ºåˆ¶åŠ è½½è¯­éŸ³...', 'solution');
            
            function tryLoadVoices() {
                const voices = window.speechSynthesis.getVoices();
                log(`å°è¯•åŠ è½½: å½“å‰æœ‰ ${voices.length} ä¸ªè¯­éŸ³`, 'solution');
                
                if (voices.length === 0) {
                    // å¦‚æœä»ç„¶ä¸ºç©ºï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
                    setTimeout(() => {
                        if (window.speechSynthesis.getVoices().length === 0) {
                            log('è¯­éŸ³ä»ä¸ºç©ºï¼Œå»ºè®®ç”¨æˆ·æ‰‹åŠ¨å¼€å¯æµè§ˆå™¨æœ—è¯»åŠŸèƒ½', 'solution');
                        }
                    }, 2000);
                } else {
                    log(`æˆåŠŸåŠ è½½ ${voices.length} ä¸ªè¯­éŸ³ï¼`, 'solution');
                }
                
                return voices;
            }
            
            // ç«‹å³å°è¯•
            tryLoadVoices();
            
            // è®¾ç½®ç›‘å¬å™¨
            window.speechSynthesis.onvoiceschanged = function() {
                const voices = window.speechSynthesis.getVoices();
                log(`voiceschangedäº‹ä»¶: ç°åœ¨æœ‰ ${voices.length} ä¸ªè¯­éŸ³`, 'solution');
            };
        });

        document.getElementById('retryWithDelay').addEventListener('click', function() {
            log('å¼€å§‹å»¶è¿Ÿé‡è¯•åŠ è½½è¯­éŸ³...', 'solution');
            
            let retryCount = 0;
            const maxRetries = 5;
            
            function retry() {
                retryCount++;
                const voices = window.speechSynthesis.getVoices();
                
                log(`ç¬¬ ${retryCount} æ¬¡é‡è¯•: ${voices.length} ä¸ªè¯­éŸ³`, 'solution');
                
                if (voices.length === 0 && retryCount < maxRetries) {
                    setTimeout(retry, 1000); // æ¯ç§’é‡è¯•ä¸€æ¬¡
                } else if (voices.length > 0) {
                    log(`æˆåŠŸï¼åœ¨ç¬¬ ${retryCount} æ¬¡é‡è¯•æ—¶åŠ è½½äº†è¯­éŸ³`, 'solution');
                } else {
                    log(`é‡è¯• ${maxRetries} æ¬¡åä»æœªåŠ è½½è¯­éŸ³ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨å¹²é¢„`, 'solution');
                }
            }
            
            // è®¾ç½®ç›‘å¬å™¨
            window.speechSynthesis.onvoiceschanged = function() {
                const voices = window.speechSynthesis.getVoices();
                log(`voiceschangedäº‹ä»¶è§¦å‘: ${voices.length} ä¸ªè¯­éŸ³`, 'solution');
                if (voices.length > 0) {
                    log('è¯­éŸ³å·²åŠ è½½ï¼Œå¯ä»¥åœæ­¢é‡è¯•', 'solution');
                }
            };
            
            retry();
        });

        // æ–°æ–¹æ¡ˆï¼šé¡µé¢åŠ è½½æ—¶åˆå§‹åŒ– + ç”¨æˆ·äº¤äº’å¼ºåˆ¶åˆå§‹åŒ–
        let initializationAttempted = false;
        let voicesChangedReceived = false;

        /**
         * é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–å‡½æ•°
         * è°ƒç”¨getVoices()å¹¶è®¾ç½®äº‹ä»¶ç›‘å¬
         */
        function initializeOnLoad() {
            log('é¡µé¢åŠ è½½ - å¼€å§‹åˆå§‹åŒ–è¯­éŸ³ç³»ç»Ÿ...', 'newSolution');
            
            // 1. ç«‹å³è°ƒç”¨getVoices()
            const initialVoices = window.speechSynthesis.getVoices();
            log(`åˆå§‹getVoices()è¿”å›: ${initialVoices.length} ä¸ªè¯­éŸ³`, 'newSolution');
            
            // 2. è®¾ç½®voiceschangedäº‹ä»¶ç›‘å¬
            window.speechSynthesis.onvoiceschanged = function() {
                voicesChangedReceived = true;
                const voices = window.speechSynthesis.getVoices();
                log(`ğŸ‰ voiceschangedäº‹ä»¶è§¦å‘ï¼ç°åœ¨æœ‰ ${voices.length} ä¸ªè¯­éŸ³`, 'newSolution');
                
                if (voices.length > 0) {
                    log('âœ… è¯­éŸ³åˆ—è¡¨å·²æˆåŠŸåŠ è½½', 'newSolution');
                    updateStatus('voiceStatus', `è¯­éŸ³åŠ è½½æˆåŠŸï¼å…± ${voices.length} ä¸ªè¯­éŸ³`, 'success');
                }
            };
            
            log('âœ… å·²è®¾ç½®voiceschangedäº‹ä»¶ç›‘å¬å™¨', 'newSolution');
            
            if (initialVoices.length === 0) {
                log('âš ï¸ åˆå§‹è¯­éŸ³åˆ—è¡¨ä¸ºç©ºï¼Œç­‰å¾…ç”¨æˆ·äº¤äº’è§¦å‘å¼ºåˆ¶åˆå§‹åŒ–', 'newSolution');
                updateStatus('voiceStatus', 'è¯­éŸ³åˆ—è¡¨ä¸ºç©ºï¼Œè¯·ç‚¹å‡»æŒ‰é’®å¼ºåˆ¶åˆå§‹åŒ–', 'warning');
            }
        }

        /**
         * å¼ºåˆ¶åˆå§‹åŒ–è¯­éŸ³å¼•æ“
         * é€šè¿‡ç©ºç™½æœ—è¯»è§¦å‘è¯­éŸ³ç³»ç»Ÿåˆå§‹åŒ–
         */
        function forceInitializeVoiceEngine() {
            log('ğŸš€ æ‰§è¡Œå¼ºåˆ¶åˆå§‹åŒ–è¯­éŸ³å¼•æ“...', 'newSolution');
            
            if (!window.speechSynthesis) {
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ', 'newSolution');
                return;
            }
            
            try {
                // åˆ›å»ºä¸€ä¸ªç©ºç™½çš„è¯­éŸ³åˆæˆè¯·æ±‚
                const emptyUtterance = new SpeechSynthesisUtterance('');
                emptyUtterance.volume = 0; // é™éŸ³ï¼Œé¿å…ç”¨æˆ·å¬åˆ°å£°éŸ³
                
                log('ğŸ”„ åˆ›å»ºç©ºç™½è¯­éŸ³è¯·æ±‚...', 'newSolution');
                
                // ç›‘å¬äº‹ä»¶ä»¥ç¡®ä¿åˆå§‹åŒ–å®Œæˆ
                emptyUtterance.onstart = function() {
                    log('âœ… ç©ºç™½è¯­éŸ³è¯·æ±‚å·²å¼€å§‹ï¼ˆå¼•æ“å·²æ¿€æ´»ï¼‰', 'newSolution');
                };
                
                emptyUtterance.onend = function() {
                    log('âœ… ç©ºç™½è¯­éŸ³è¯·æ±‚å·²å®Œæˆ', 'newSolution');
                    
                    // æ£€æŸ¥è¯­éŸ³åˆ—è¡¨æ˜¯å¦å·²æ›´æ–°
                    setTimeout(() => {
                        const voices = window.speechSynthesis.getVoices();
                        log(`ğŸ“ å¼ºåˆ¶åˆå§‹åŒ–ågetVoices()è¿”å›: ${voices.length} ä¸ªè¯­éŸ³`, 'newSolution');
                        
                        if (voices.length > 0) {
                            log('ğŸ‰ æˆåŠŸï¼å¼ºåˆ¶åˆå§‹åŒ–å·²ç”Ÿæ•ˆ', 'newSolution');
                            updateStatus('voiceStatus', `å¼ºåˆ¶åˆå§‹åŒ–æˆåŠŸï¼å…± ${voices.length} ä¸ªè¯­éŸ³`, 'success');
                        } else {
                            log('âš ï¸ å¼ºåˆ¶åˆå§‹åŒ–å¯èƒ½æœªå®Œæˆï¼Œç­‰å¾…voiceschangedäº‹ä»¶...', 'newSolution');
                        }
                    }, 100);
                };
                
                // ç«‹å³æ‰§è¡Œç©ºç™½æœ—è¯»ä»¥å¼ºåˆ¶åˆå§‹åŒ–
                window.speechSynthesis.speak(emptyUtterance);
                log('âœ… å·²å‘é€ç©ºç™½è¯­éŸ³è¯·æ±‚', 'newSolution');
                
                initializationAttempted = true;
                
            } catch (error) {
                log(`âŒ å¼ºåˆ¶åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'newSolution');
            }
        }

        /**
         * å®Œæ•´æµ‹è¯•æ–°æ–¹æ¡ˆ
         */
        function testCompleteSolution() {
            log('ğŸ§ª å¼€å§‹å®Œæ•´æµ‹è¯•æ–°æ–¹æ¡ˆ...', 'newSolution');
            
            // æ­¥éª¤1: æ£€æŸ¥å½“å‰çŠ¶æ€
            const currentVoices = window.speechSynthesis.getVoices();
            log(`ğŸ“Š å½“å‰è¯­éŸ³æ•°é‡: ${currentVoices.length}`, 'newSolution');
            
            if (currentVoices.length > 0) {
                log('âœ… è¯­éŸ³åˆ—è¡¨å·²åŠ è½½ï¼Œæ— éœ€å¼ºåˆ¶åˆå§‹åŒ–', 'newSolution');
                return;
            }
            
            // æ­¥éª¤2: æ‰§è¡Œå¼ºåˆ¶åˆå§‹åŒ–
            log('ğŸ”„ è¯­éŸ³åˆ—è¡¨ä¸ºç©ºï¼Œæ‰§è¡Œå¼ºåˆ¶åˆå§‹åŒ–...', 'newSolution');
            forceInitializeVoiceEngine();
            
            // æ­¥éª¤3: ç­‰å¾…å¹¶éªŒè¯ç»“æœ
            setTimeout(() => {
                const finalVoices = window.speechSynthesis.getVoices();
                log(`â° ç­‰å¾…åè¯­éŸ³æ•°é‡: ${finalVoices.length}`, 'newSolution');
                
                if (finalVoices.length > 0) {
                    log('ğŸ‰ æ–°æ–¹æ¡ˆæµ‹è¯•æˆåŠŸï¼', 'newSolution');
                } else if (voicesChangedReceived) {
                    log('âš ï¸ voiceschangedäº‹ä»¶å·²è§¦å‘ä½†è¯­éŸ³ä»ä¸ºç©ºï¼Œå¯èƒ½éœ€è¦å…¶ä»–æ–¹æ³•', 'newSolution');
                } else {
                    log('â³ voiceschangedäº‹ä»¶å°šæœªè§¦å‘ï¼Œç»§ç»­ç­‰å¾…...', 'newSolution');
                }
            }, 2000);
        }

        /**
         * é‡ç½®çŠ¶æ€
         */
        function resetState() {
            initializationAttempted = false;
            voicesChangedReceived = false;
            newSolutionLogDiv.innerHTML = '';
            log('ğŸ”„ çŠ¶æ€å·²é‡ç½®', 'newSolution');
            updateStatus('voiceStatus', 'çŠ¶æ€å·²é‡ç½®', 'success');
        }

        // ç»‘å®šæ–°æ–¹æ¡ˆæŒ‰é’®äº‹ä»¶
        document.getElementById('initVoiceEngine').addEventListener('click', forceInitializeVoiceEngine);
        document.getElementById('testNewSolution').addEventListener('click', testCompleteSolution);
        document.getElementById('resetState').addEventListener('click', resetState);

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹
        window.addEventListener('load', function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œè‡ªåŠ¨æ£€æµ‹è¯­éŸ³çŠ¶æ€...', 'solution');
            const voices = window.speechSynthesis.getVoices();
            log(`åˆå§‹çŠ¶æ€: ${voices.length} ä¸ªè¯­éŸ³`, 'solution');
            
            if (voices.length === 0) {
                updateStatus('voiceStatus', 'æ£€æµ‹åˆ°è¯­éŸ³åˆ—è¡¨ä¸ºç©ºï¼Œè¿™æ˜¯å®‰å“Edgeæµè§ˆå™¨çš„å·²çŸ¥é—®é¢˜', 'warning');
            }
            
            // æ‰§è¡Œæ–°æ–¹æ¡ˆçš„åˆå§‹åŒ–
            initializeOnLoad();
        });
    </script>
</body>
</html>