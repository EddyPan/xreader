# 系统开始/暂停事件监听功能

## 功能概述

本阅读器应用实现了完整的系统语音合成事件监听功能，能够响应系统级别的开始、暂停、恢复、停止和错误事件，确保朗读状态与系统状态保持同步。

## 主要功能特性

### 1. 系统语音合成事件监听

监听以下系统事件并自动更新UI状态：

- **`onstart`** - 系统开始朗读事件
- **`onpause`** - 系统暂停朗读事件  
- **`onresume`** - 系统恢复朗读事件
- **`onend`** - 系统结束朗读事件
- **`onerror`** - 系统语音合成错误事件

### 2. 媒体会话API支持

支持现代浏览器的媒体会话API，可以通过以下方式控制朗读：

- **媒体键** - 键盘上的播放/暂停键
- **通知栏控制** - 系统通知栏的媒体控制
- **浏览器媒体控制** - 浏览器内置的媒体控制界面

### 3. 页面可见性监听

- 当页面隐藏时自动暂停朗读
- 当页面显示时自动恢复朗读（如果之前正在朗读）
- 节省系统资源，提升用户体验

### 4. 智能状态同步

- 自动检测系统语音合成状态变化
- 同步更新UI按钮状态和显示
- 防止状态不一致导致的用户体验问题

## 技术实现

### 核心函数

#### `setupSpeechEventListeners()`
设置系统语音合成事件监听器，监听所有相关的系统事件。

#### `removeSpeechEventListeners()`  
清理事件监听器，防止内存泄漏。

#### `setupMediaSession()`
配置媒体会话API，支持浏览器媒体控制。

#### `setupVisibilityChange()`
设置页面可见性变化监听。

### 事件处理流程

```
用户操作/系统事件 → 事件监听器 → 状态更新 → UI同步
```

1. **事件捕获** - 监听系统语音合成事件
2. **状态判断** - 分析当前朗读状态
3. **状态更新** - 更新内部状态变量
4. **UI同步** - 更新按钮显示和界面状态

## 使用说明

### 基本使用

1. **开始朗读** - 点击"朗读"按钮或按空格键
2. **暂停朗读** - 点击"暂停"按钮或再次按空格键
3. **停止朗读** - 点击"停止"按钮或按S键

### 系统控制

- **媒体键** - 使用键盘的播放/暂停键
- **通知栏** - 在支持的设备上使用通知栏媒体控制
- **页面切换** - 切换标签页时自动暂停/恢复

### 状态指示

- **绿色按钮** - 表示正在朗读
- **灰色按钮** - 表示朗读已暂停或停止
- **高亮段落** - 当前正在朗读的段落会高亮显示

## 浏览器兼容性

### 支持的功能

| 功能 | Chrome | Firefox | Safari | Edge |
|------|--------|---------|--------|------|
| 语音合成事件 | ✅ | ✅ | ✅ | ✅ |
| 媒体会话API | ✅ | ❌ | ✅ | ✅ |
| 页面可见性 | ✅ | ✅ | ✅ | ✅ |

### 注意事项

1. **安卓Edge浏览器** - 可能需要在浏览器设置中开启"大声朗读"功能
2. **语音加载** - 首次使用可能需要等待语音列表加载完成
3. **权限要求** - 某些浏览器可能需要用户交互才能启用语音功能

## 测试方法

### 使用测试页面

打开 `test-system-events.html` 文件进行功能测试：

1. 测试基本朗读控制
2. 验证系统事件监听
3. 检查媒体会话集成
4. 验证页面可见性处理

### 手动测试步骤

1. **开始朗读** - 观察事件日志和UI变化
2. **暂停/恢复** - 测试按钮和系统控制
3. **页面切换** - 验证自动暂停/恢复功能
4. **错误处理** - 测试异常情况下的表现

## 故障排除

### 常见问题

#### 事件监听不工作
- 检查浏览器是否支持语音合成API
- 确认语音列表已加载完成
- 查看浏览器控制台是否有错误信息

#### 媒体控制无效
- 确认浏览器支持媒体会话API
- 检查是否有用户交互权限限制
- 验证媒体会话元数据是否正确设置

#### 状态不同步
- 检查事件监听器是否正确初始化
- 确认状态变量更新逻辑
- 验证UI更新函数是否被调用

### 调试信息

系统会在控制台输出详细的事件日志：

```
系统开始朗读事件触发
用户手动暂停朗读
系统暂停朗读事件触发
页面隐藏，暂停朗读
```

## 性能优化

### 防抖处理
- 使用防抖机制避免频繁的状态更新
- 优化事件处理性能

### 内存管理
- 及时清理事件监听器
- 避免内存泄漏

### 资源节约
- 页面隐藏时自动暂停朗读
- 优化语音合成资源使用

## 更新日志

### v1.0.0 (2024-01-XX)
- ✨ 新增系统语音合成事件监听
- ✨ 新增媒体会话API支持  
- ✨ 新增页面可见性监听
- ✨ 新增智能状态同步
- ✨ 新增完整的错误处理
- ✨ 新增测试页面和文档

---

如需更多帮助或报告问题，请查看浏览器控制台日志或联系开发团队。